import axios from 'axios';

let handler = async (m, { conn, text, command }) => {
  if (!text) {
    return m.reply('ğŸš« Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ø£ØºÙ†ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±.\nÙ…Ø«Ø§Ù„:\n*.play hello*');
  }

  try {
    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    // ğŸ”µ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ù…Ø²Ø®Ø±ÙØ©
    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    const frames = [
      "ï¼¬",
      "ï¼¬ï½",
      "ï¼¬ï½ï½",
      "ï¼¬ï½ï½ï½„",
      "ï¼¬ï½ï½ï½„ï½‰",
      "ï¼¬ï½ï½ï½„ï½‰ï½",
      "ï¼¬ï½ï½ï½„ï½‰ï½ï½‡",
      "ï¼¬ï½ï½ï½„ï½‰ï½ï½‡ï¼",
      "ï¼¬ï½ï½ï½„ï½‰ï½ï½‡ï¼ï¼",
      "ï¼¬ï½ï½ï½„ï½‰ï½ï½‡ï¼ï¼ï¼"
    ];

    let loadingMsg = await conn.sendMessage(m.chat, { text: frames[0] }, { quoted: m });

    for (let i = 1; i < frames.length; i++) {
      await new Promise(res => setTimeout(res, 400));
      await conn.sendMessage(
        m.chat,
        { text: frames[i], edit: loadingMsg.key },
      );
    }

    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    // ğŸ” Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ØºÙ†ÙŠØ© Ù…Ù† API
    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    const res = await axios.get(`https://pursky.vercel.app/api/ytplay?q=${encodeURIComponent(text)}`);
    const audio = res.data?.audio;

    if (!audio) {
      return conn.sendMessage(m.chat, { text: "âŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª." }, { edit: loadingMsg.key });
    }

    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    // ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØµÙˆØª
    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    const headers = res.data.note?.headers || {};
    const audioRes = await axios.get(audio, {
      responseType: "arraybuffer",
      headers: {
        "User-Agent": headers["User-Agent"] || "Mozilla/5.0 (Linux; Android 10)",
        "Referer": headers["Referer"] || audio
      }
    });

    let filename = text.replace(/\s+/g, "_") + ".mp3";

    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    // ğŸµ Ø¥Ø±Ø³Ø§Ù„ mp3 ÙƒÙ€ Audio Ø·Ø¨ÙŠØ¹ÙŠ (Ù„ÙŠØ³ voice note)
    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    await conn.sendMessage(
      m.chat,
      {
        audio: Buffer.from(audioRes.data),
        mimetype: "audio/mpeg",
        fileName: filename,
        ptt: false
      },
      { quoted: m }
    );

    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    // âœ”ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    // Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€
    await conn.sendMessage(
      m.chat,
      {
        text: "âœ”ï¸ ØªÙ€Ù€Ù…Ù€Ù€ ØªÙ€Ù€Ù€Ø­Ù€Ù€Ù…Ù€Ù€ÙŠÙ€Ù€Ù„Ù€Ù€ Ø§Ù„Ù€Ù€Ø§Ù”ØºÙ€Ù€Ù†Ù€Ù€ÙŠÙ€Ù€Ø© Ø¨Ù€Ù€Ù†Ù€Ù€Ø¬Ù€Ù€Ø§Ø­ ğŸ¶",
        edit: loadingMsg.key
      }
    );

  } catch (err) {
    console.error(err);
    return m.reply("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª.");
  }
};

handler.help = ['play'];
handler.arabic = ['Ø´ØºÙ„']
handler.command = ['play','Ø´ØºÙ„'];
handler.tags = ['downloader'];
handler.limit = false;
handler.register = false;

export default handler;